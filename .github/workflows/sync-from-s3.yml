name: Sync New Posts from S3

on:
  schedule:
    - cron: '5 * * * *'  # ë§¤ ì‹œ 5ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:     # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-northeast-2
      AWS_BUCKET: smallnotes

    steps:
      - name: Checkout blog repo
        uses: actions/checkout@v4

      - name: Set up AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync new posts only
        run: |
          set -euxo pipefail

          # ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ ê²½ë¡œ
          year=$(date +%Y)
          month=$(date +%m)
          prefix="posts/$year/$month"

          # 1. í˜„ì¬ ë ˆí¬ì— ìˆëŠ” slug ëª©ë¡
          existing_slugs=$(ls _posts | sed 's/\.md$//')

          # 2. S3ì—ì„œ article.md ê²½ë¡œë§Œ ê°€ì ¸ì˜¤ê¸°
          s3_objects=$(aws s3api list-objects-v2 \
            --bucket "$AWS_BUCKET" \
            --prefix "$prefix/" \
            --query 'Contents[?ends_with(Key, `article.md`)].Key' \
            --output text)

          if [ -z "$s3_objects" ]; then
            echo "âœ… ì˜¤ëŠ˜ ì˜¬ë¼ì˜¨ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 0
          fi

          echo "$s3_objects" | tr '\t' '\n' | while read -r path; do
            slug=$(basename "$(dirname "$path")")

            if ! echo "$existing_slugs" | grep -qx "$slug"; then
              echo "ğŸ“„ ìƒˆ ê¸€ ë°œê²¬: $slug"

              aws s3 cp "s3://$AWS_BUCKET/$path" "_posts/${slug}.md"

              image_path="s3://$AWS_BUCKET/$(dirname "$path")/images"
              if aws s3 ls "$image_path" > /dev/null 2>&1; then
                aws s3 sync "$image_path" "assets/img/${slug}/" \
                  --exact-timestamps \
                  --exclude "*" --include "*.png"
              fi
            else
              echo "âœ… ì´ë¯¸ ìˆëŠ” ê¸€: $slug (ê±´ë„ˆëœ€)"
            fi
          done

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
    
      - name: Commit and push
        run: |
          set -euxo pipefail

          git add _posts/ assets/img/
          if ! git diff --cached --quiet; then
            git commit -m "chore: auto sync new posts from S3"
            git push
          else
            echo "âœ… ë³€ê²½ ì‚¬í•­ ì—†ìŒ (ì»¤ë°‹ ìƒëµ)"
          fi
